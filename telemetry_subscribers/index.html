<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Telemetry-subscribers"><meta name="keywords" content="rust, rustlang, rust-lang, telemetry_subscribers"><title>telemetry_subscribers - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-1f7d512b176f0f72.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Bold-124a1ca42af929b6.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-ed67f58bef457aa5.css" id="mainThemeStyle"><link rel="stylesheet" id="themeStyle" href="../static.files/light-a19f8302ea709214.css"><link rel="stylesheet" disabled href="../static.files/dark-f1e56666dd272622.css"><link rel="stylesheet" disabled href="../static.files/ayu-7291d283d92e041c.css"><script id="default-settings" ></script><script src="../static.files/storage-d43fa987303ecbbb.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-4a084badb5778746.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../telemetry_subscribers/index.html"><div class="logo-container"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></div></a><h2></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../telemetry_subscribers/index.html"><div class="logo-container"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></div></a><h2 class="location"><a href="#">Crate telemetry_subscribers</a></h2><div class="sidebar-elems"><ul class="block"><li class="version">Version 0.2.0</li><li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#functions">Functions</a></li><li><a href="#types">Type Definitions</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-5ec35bf9ca753509.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn">Crate <a class="mod" href="#">telemetry_subscribers</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../src/telemetry_subscribers/lib.rs.html#4-495">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="telemetry-subscribers"><a href="#telemetry-subscribers">Telemetry-subscribers</a></h2>
<p>This is a library for common telemetry functionality, especially subscribers for <a href="https://github.com/tokio-rs/tracing">Tokio tracing</a>
libraries.  Here we simply package many common subscribers, such as writing trace data to Jaeger, distributed tracing,
common logs and metrics destinations, etc.  into a easy to configure common package.  There are also
some unique layers such as one to automatically create Prometheus latency histograms for spans.</p>
<p>We also purposely separate out logging levels from span creation.  This is often needed by production apps
as normally it is not desired to log at very high levels, but still desirable to gather sampled span data
all the way down to TRACE level spans.</p>
<p>Getting started is easy.  In your app:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code>  <span class="kw">use </span>telemetry_subscribers::TelemetryConfig;
  <span class="kw">let </span>(_guard, _handle) = TelemetryConfig::new(<span class="string">&quot;my_app&quot;</span>).init();</code></pre></div>
<p>It is important to retain the guard until the end of the program.  Assign it in the main fn and keep it,
for once it drops then log output will stop.</p>
<p>There is a builder API available: just do <code>TelemetryConfig::new()...</code> Another convenient initialization method
is <code>TelemetryConfig::new().with_env()</code> to populate the config from environment vars.</p>
<p>You can also run the example and see output in ANSI color:</p>
<div class="example-wrap"><pre class="language-bash"><code>    cargo run --example easy-init
</code></pre></div><h3 id="features"><a href="#features">Features</a></h3>
<ul>
<li><code>jaeger</code> - this feature is enabled by default as it enables jaeger tracing</li>
<li><code>json</code> - Bunyan formatter - JSON log output, optional</li>
<li><code>tokio-console</code> - <a href="https://github.com/tokio-rs/console">Tokio-console</a> subscriber, optional</li>
</ul>
<h4 id="stdout-vs-file-output"><a href="#stdout-vs-file-output">Stdout vs file output</a></h4>
<p>By default, logs (but not spans) are formatted for human readability and output to stdout, with key-value tags at the end of every line.
<code>RUST_LOG</code> can be configured for custom logging output, including filtering.</p>
<p>By setting <code>log_file</code> in the config, one can write log output to a daily-rotated file.</p>
<h4 id="tracing-and-span-output"><a href="#tracing-and-span-output">Tracing and span output</a></h4>
<p>Detailed span start and end logs can be generated by defining the <code>json_log_output</code> config variable.  Note that this causes all output to be in JSON format, which is not as human-readable, so it is not enabled by default.
This output can easily be fed to backends such as ElasticSearch for indexing, alerts, aggregation, and analysis.</p>
<p>NOTE: JSON output requires the <code>json</code> crate feature to be enabled.</p>
<h4 id="jaeger-seeing-distributed-traces"><a href="#jaeger-seeing-distributed-traces">Jaeger (seeing distributed traces)</a></h4>
<p>To see nested spans visualized with <a href="https://www.jaegertracing.io">Jaeger</a>, do the following:</p>
<ol>
<li>Run this to get a local Jaeger container: <code>docker run -d -p6831:6831/udp -p6832:6832/udp -p16686:16686 jaegertracing/all-in-one:latest</code></li>
<li>Set <code>enable_jaeger</code> config setting to true or set <code>TOKIO_JAEGER</code> env var</li>
<li>Run your app</li>
<li>Browse to <code>http://localhost:16686/</code> and select the service you configured using <code>service_name</code></li>
</ol>
<p>NOTE: separate spans (which are not nested) are not connected as a single trace for now.</p>
<p>Jaeger subscriber is enabled by default but is protected by the jaeger feature flag.  If you’d like to leave
out the Jaeger dependencies, you can turn off the default-features in your dependency:</p>
<div class="example-wrap"><pre class="language-toml"><code>    telemetry = { url = &quot;...&quot;, default-features = false }
</code></pre></div><h4 id="automatic-prometheus-span-latencies"><a href="#automatic-prometheus-span-latencies">Automatic Prometheus span latencies</a></h4>
<p>Included in this library is a tracing-subscriber layer named <code>PrometheusSpanLatencyLayer</code>.  It will create
a Prometheus histogram to track latencies for every span in your app, which is super convenient for tracking
span performance in production apps.</p>
<p>Enabling this layer can only be done programmatically, by passing in a Prometheus registry to <code>TelemetryConfig</code>.</p>
<h4 id="span-levels-vs-log-levels"><a href="#span-levels-vs-log-levels">Span levels vs log levels</a></h4>
<p>What spans are included for Jaeger output, automatic span latencies, etc.?  These are controlled by
the <code>span_level</code> config attribute, or the <code>TS_SPAN_LEVEL</code> environment variable.  Note that this is
separate from <code>RUST_LOG</code>, so that you can separately control the logging verbosity from the level of
spans that are to be recorded and traced.</p>
<h4 id="live-async-inspection--tokio-console"><a href="#live-async-inspection--tokio-console">Live async inspection / Tokio Console</a></h4>
<p><a href="https://github.com/tokio-rs/console">Tokio-console</a> is an awesome CLI tool designed to analyze and help debug Rust apps using Tokio, in real time!  It relies on a special subscriber.</p>
<ol>
<li>Build your app using a special flag: <code>RUSTFLAGS=&quot;--cfg tokio_unstable&quot; cargo build</code></li>
<li>Enable the <code>tokio-console</code> feature for this crate.</li>
<li>Set the <code>tokio_console</code> config setting when running your app (or set TOKIO_CONSOLE env var if using config <code>with_env()</code> method)</li>
<li>Clone the console repo and <code>cargo run</code> to launch the console</li>
</ol>
<p>NOTE: setting tokio TRACE logs is NOT necessary.  It says that in the docs but there’s no need to change Tokio logging levels at all.  The console subscriber has a special filter enabled taking care of that.</p>
<p>By default, Tokio console listens on port 6669.  To change this setting as well as other setting such as
the retention policy, please see the <a href="https://docs.rs/console-subscriber/latest/console_subscriber/struct.Builder.html#configuration">configuration</a> guide.</p>
<h4 id="custom-panic-hook"><a href="#custom-panic-hook">Custom panic hook</a></h4>
<p>This library installs a custom panic hook which records a log (event) at ERROR level using the tracing
crate.  This allows span information from the panic to be properly recorded as well.</p>
<p>To exit the process on panic, set the <code>CRASH_ON_PANIC</code> environment variable.</p>
</div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="mod" href="span_latency_prom/index.html" title="telemetry_subscribers::span_latency_prom mod">span_latency_prom</a></div><div class="item-right docblock-short">This is a module that records Tokio-tracing <a href="https://docs.rs/tracing/latest/tracing/span/index.html">span</a>
latencies into Prometheus histograms directly.
The name of the Prometheus histogram is “tracing_span_latencies[_sum/count/bucket]”</div></div></div><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.FilterHandle.html" title="telemetry_subscribers::FilterHandle struct">FilterHandle</a></div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.TelemetryConfig.html" title="telemetry_subscribers::TelemetryConfig struct">TelemetryConfig</a></div><div class="item-right docblock-short">Configuration for different logging/tracing options</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.TelemetryGuards.html" title="telemetry_subscribers::TelemetryGuards struct">TelemetryGuards</a></div></div></div><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.init_for_testing.html" title="telemetry_subscribers::init_for_testing fn">init_for_testing</a></div><div class="item-right docblock-short">Globally set a tracing subscriber suitable for testing environments</div></div></div><h2 id="types" class="small-section-header"><a href="#types">Type Definitions</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="type" href="type.BoxError.html" title="telemetry_subscribers::BoxError type">BoxError</a></div><div class="item-right docblock-short">Alias for a type-erased error type.</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="telemetry_subscribers" data-themes="" data-resource-suffix="" data-rustdoc-version="1.68.0-nightly (af3e06f1b 2022-12-23)" data-search-js="search-444266647c4dba98.js" data-settings-js="settings-bebeae96e00e4617.js" data-settings-css="settings-58836c674e2f7bd2.css" ></div></body></html>